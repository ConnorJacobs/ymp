from ymp.util import glob_wildcards
from ymp.config import icfg

rule megahit_partial_coassembly:
    """
    Specialized megahit assembly rule for co-assembly by column value

    use with reads.by_COLUMN.mhc/complete as target

    Same as general megahit rule, but does co-assemblies on groups in the
    data (e.g. by subject)
    """
    message:
        "Co-Assembling {wildcards.target} with megahit"
    input:
        r1="{dir}/{: sources :}.{: pairnames[0] :}.fq.gz",
        r2="{dir}/{: sources :}.{: pairnames[1] :}.fq.gz"
    output:
        fasta = "{dir}{by}.mhc/{target}.contigs.fasta.gz",
        fastg = "{dir}{by}.mhc/{target}.contigs.fastg.gz"
    log:
        "{dir}{by}.mhc/{target}.log.gz"
    params:
        workdir="{dir}{by}.mhc/{target}/",
    threads:
        16
# FIXME: work around need for run: using param
# so that conda will work
#    conda:
#        srcdir("megahit.yml")
    run:
        if isinstance(input.r1, str):
            input.r1 = [input.r1]
            input.r2 = [input.r2]
            
        csr1=",".join(input.r1)
        csr2=",".join(input.r2)

        shell("""
    # delete workdir if no opts.txt was recorded (never started really)
    [ -e {params.workdir}/opts.txt ] || rm -rf {params.workdir}

    megahit -1 {csr1} -2 {csr2} \
      --presets meta-sensitive \
      --num-cpu-threads {threads} \
      --out-dir {params.workdir} \
      --tmp-dir /scratch/$HOME/tmp \

    # quit if not finished
    [ -e {params.workdir}/done ] || exit 1

    # output zipped contigs
    pigz -p {threads} -9 -c {params.workdir}/final.contigs.fa > {output.fasta}

    # output the zipped log
    cat {params.workdir}/{{opts.txt,log}} |\
    pigz -p {threads} -9 -c > {log}

    # determine largest K used
    MAXK=`tac {params.workdir}/log | sed -nr 's/^---.*k = ([0-9]{{2,3}}) ---/\\1/p;' | head -n1`

    # output the zipped fastg
    megahit_toolkit contig2fastg $MAXK \
    {params.workdir}/intermediate_contigs/k${{MAXK}}.contigs.fa |\
    pigz -p {threads} -9 -c > {output.fastg}

    # remove intermediate contigs
    #rm -rf {params.workdir}
    """)




    
